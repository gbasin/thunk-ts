<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#2d2a26" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>PL4N v0.1 - Plan Editor</title>
    <link rel="stylesheet" href="/assets/styles.css?v=6" />
    <link rel="stylesheet" href="/assets/prototype/tui-styles.css" />
    <style>
      html { background: #2d2a26; }
      body { background: #f5f3ef; }
    </style>
  </head>
  <body>
    <div class="tui-page">
      <div class="tui-title-bar">
        <span class="title">pl4n</span>
        <span class="tui-nav">
          <a class="tui-nav-link" href="/projects?t=__GLOBAL_TOKEN__">Projects</a>
          <a class="tui-nav-link" href="/projects/__PROJECT_ID__/sessions?t=__GLOBAL_TOKEN__">
            Sessions
          </a>
        </span>
        <span class="session-name">__SESSION_ID__</span>
        <span class="font-controls">
          <button class="font-btn" id="font-down" title="Decrease font size">-</button>
          <span class="font-size" id="font-size">10</span>
          <button class="font-btn" id="font-up" title="Increase font size">+</button>
        </span>
      </div>

      <div class="tui-info-bar">
        <div class="tui-info-item">
          <span class="tui-info-label">TURN</span>
          <span class="tui-info-value" id="info-turn">__TURN__</span>
        </div>
        <div class="tui-info-item">
          <span class="tui-info-label">PHASE</span>
          <span class="tui-info-value" id="info-phase">__PHASE__</span>
        </div>
        <div class="tui-info-item">
          <span class="tui-info-label">STATUS</span>
          <span class="tui-info-value status-ready" id="info-status">READY</span>
        </div>
      </div>

      <div class="tui-panel">
        <span class="tui-panel-header">__PROJECT_NAME__</span>
        <div class="tui-panel-content">
          <pl4n-editor
            data-session="__SESSION_ID__"
            data-token="__TOKEN__"
            data-turn="__TURN__"
            data-phase="__PHASE__"
            data-read-only="__READ_ONLY__"
            data-project-id="__PROJECT_ID__"
            data-project-name="__PROJECT_NAME__"
            data-global-token="__GLOBAL_TOKEN__"
          ></pl4n-editor>
        </div>
      </div>

      <div class="tui-status-bar">
        <div class="tui-status-left">
          <span class="tui-file-path">__FILE_PATH__</span>
        </div>
        <div class="tui-status-right">
          <span class="tui-status-hint">^S Save | ^Enter Continue</span>
        </div>
      </div>
    </div>
    <script type="module" src="/assets/editor.js"></script>
    <script>
      let fontSize = 10;
      const minFontSize = 4;
      const maxFontSize = 24;
      function updateFontSize(newSize) {
        fontSize = Math.max(minFontSize, Math.min(maxFontSize, newSize));
        document.documentElement.style.setProperty('--tui-font-size', fontSize + 'px');
        document.documentElement.style.setProperty('--editor-font-size', fontSize + 'px');
        document.getElementById('font-size').textContent = fontSize;
      }
      updateFontSize(fontSize);
      document.getElementById('font-up').addEventListener('click', () => updateFontSize(fontSize + 1));
      document.getElementById('font-down').addEventListener('click', () => updateFontSize(fontSize - 1));

      const phaseEl = document.getElementById('info-phase');
      if (phaseEl) {
        phaseEl.textContent = (phaseEl.textContent || '').replace(/_/g, ' ');
      }
      const turnEl = document.getElementById('info-turn');
      if (turnEl) {
        const value = parseInt(turnEl.textContent || '0', 10);
        if (!Number.isNaN(value)) {
          turnEl.textContent = String(value).padStart(3, '0');
        }
      }

      const observer = new MutationObserver(() => {
        const editor = document.querySelector('pl4n-editor');
        if (!editor) return;
        const statusEl = editor.querySelector('.status');
        const panelHeader = document.querySelector('.tui-panel-header');
        if (!statusEl) return;

        const statusText = statusEl.textContent || '';
        const infoStatus = document.getElementById('info-status');
        infoStatus.className = 'tui-info-value';

        const isModified = statusText.includes('Unsaved') || statusText.includes('changes');
        if (panelHeader) {
          panelHeader.classList.toggle('modified', isModified);
        }

        if (statusText.includes('Working') || statusText.includes('Saving')) {
          infoStatus.classList.add('status-working');
          infoStatus.textContent = 'SAVING';
        } else if (statusText.toLowerCase().includes('failed') || statusText.toLowerCase().includes('error')) {
          infoStatus.classList.add('status-error');
          infoStatus.textContent = 'ERROR';
        } else if (isModified) {
          infoStatus.classList.add('status-working');
          infoStatus.textContent = 'MODIFIED';
        } else {
          infoStatus.classList.add('status-ready');
          infoStatus.textContent = 'READY';
        }
      });

      requestAnimationFrame(function check() {
        const editor = document.querySelector('pl4n-editor');
        if (editor) {
          observer.observe(editor, { childList: true, subtree: true, characterData: true });
        } else {
          requestAnimationFrame(check);
        }
      });
    </script>
  </body>
</html>
